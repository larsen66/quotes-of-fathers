# ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ

## Архитектура, стек и офлайн-режим

### Проект: «Цитаты Отцов»

---

## 1. Утверждённый технологический стек

### TR-1. Бэкенд и контент

* **TR-1.1:** В качестве бэкенда используется **Supabase**.
* **TR-1.2:** Хранилище данных — **Supabase Postgres**.
* **TR-1.3:** Хранилище медиа — **Supabase Storage**.
* **TR-1.4:** Аутентификация администраторов — **Supabase Auth**.
* **TR-1.5:** Серверная логика (при необходимости) — **Supabase Edge Functions**.

### TR-2. Админ-панель

* **TR-2.1:** Админ-панель реализуется как веб-приложение на **React** (с TypeScript).
* **TR-2.2:** Админ-панель использует **Supabase JS Client** для работы с базой данных и Supabase Storage.
* **TR-2.3:** Хостинг админ-панели 
* **TR-2.4:** Аутентификация администраторов через **Supabase Auth**.
* **TR-2.5:** CRUD-операции для отцов и цитат реализуются через Supabase JS Client.

### TR-3. Мобильное приложение

* **TR-3.1:** Технологии: **React Native + Expo (Managed Workflow)**.
* **TR-3.2:** Локальное хранилище данных — **SQLite (expo-sqlite)**.
* **TR-3.3:** Локальное файловое хранилище — **expo-file-system**.

---

## 2. Требования к офлайн-режиму

### TR-OFF-1. Гарантия офлайн-работы

* **TR-OFF-1.1:** Приложение должно **полностью функционировать без доступа к интернету после первой успешной загрузки данных**.
* **TR-OFF-1.2:** Все основные пользовательские сценарии (чтение цитат, просмотр отцов, избранное, настройки) должны быть доступны офлайн.

### TR-OFF-2. Первый запуск

* **TR-OFF-2.1:** При первом запуске приложение требует активного интернет-соединения.
* **TR-OFF-2.2:** При отсутствии интернета на первом запуске отображается экран-заглушка с текстом:

  > «Для первой загрузки данных требуется подключение к интернету»
* **TR-OFF-2.3:** Пользователю предоставляется кнопка «Повторить попытку».

---

## 3. Локальное хранение данных

### TR-LS-1. Структура локальной базы данных

Локальная база SQLite должна содержать таблицы:

* `fathers`
* `quotes`
* `favorites`
* `settings`
* `sync_state`

### TR-LS-2. Источник отображения данных

* **TR-LS-2.1:** Приложение всегда отображает данные **из локальной базы SQLite**.
* **TR-LS-2.2:** Данные из Firestore используются **только для синхронизации**.

---

## 4. Хранение и обработка изображений

### TR-IMG-1. Стратегия хранения

* **TR-IMG-1.1:** Все изображения (аватары, профильные фото отцов) должны **загружаться на устройство при первой синхронизации**.
* **TR-IMG-1.2:** Изображения сохраняются в локальное файловое хранилище устройства.
* **TR-IMG-1.3:** В локальной базе данных хранятся пути к локальным файлам (`localPath`).

### TR-IMG-2. Использование изображений

* **TR-IMG-2.1:** При отсутствии интернета изображения должны отображаться из локального хранилища.
* **TR-IMG-2.2:** URL Firebase Storage не используются напрямую в UI после загрузки.

---

## 5. Первая загрузка данных

### TR-SYNC-1. Объём первой загрузки

* **TR-SYNC-1.1:** При первой успешной синхронизации приложение должно загрузить:

  * всех отцов
  * все опубликованные цитаты
  * все связанные изображения

### TR-SYNC-2. Завершение первой загрузки

* **TR-SYNC-2.1:** Первая загрузка считается завершённой только после успешного сохранения всех данных в SQLite и файловую систему.
* **TR-SYNC-2.2:** Флаг завершённой инициализации хранится в таблице `sync_state`.

---

## 6. Синхронизация данных

### TR-SYNC-3. Тип синхронизации

* **TR-SYNC-3.1:** Используется **инкрементальная синхронизация** по полю `updatedAt`.

### TR-SYNC-4. Момент синхронизации

* **TR-SYNC-4.1:** Синхронизация запускается:

  * при старте приложения (если доступен интернет)
  * по ручному триггеру (опционально)
* **TR-SYNC-4.2:** Синхронизация не блокирует отображение UI.

---

## 7. Удаление данных

### TR-DEL-1. Удаление на сервере

* **TR-DEL-1.1:** Если цитата или отец удалены в админ-панели, они должны быть удалены из локальной базы при следующей синхронизации.
* **TR-DEL-1.2:** Если удалённая цитата была в избранном:

  * она автоматически удаляется из списка избранного.

### TR-DEL-2. Стратегия удаления

* **TR-DEL-2.1:** Удаления обрабатываются через:

  * физическое удаление **или**
  * флаг `deleted=true` (конкретный механизм фиксируется в реализации, поведение для клиента одинаково).

---

## 8. Поведение приложения при запуске

### TR-APP-1. Приоритет данных

* **TR-APP-1.1:** При запуске приложение сначала читает данные из SQLite.
* **TR-APP-1.2:** Проверка интернета и синхронизация выполняются в фоне.

---

## 9. Ограничения и гарантии

### TR-G-1. Гарантии

* **TR-G-1.1:** Отсутствие интернета **не должно приводить к ошибкам интерфейса** после первой загрузки.
* **TR-G-1.2:** Приложение не должно зависеть от сетевых запросов для отображения контента.

### TR-G-2. Ограничения

* **TR-G-2.1:** Без интернета невозможны:

  * первая загрузка
  * отправка формы обратной связи
  * обновление счётчика подписчиков

---

## 10. Мультиязычность

### TR-LANG-1. Поддерживаемые языки

* **TR-LANG-1.1:** Мобильное приложение должно поддерживать два языка интерфейса:
  * **Грузинский (ka)** — основной язык
  * **Русский (ru)** — дополнительный язык
* **TR-LANG-1.2:** Язык интерфейса выбирается пользователем в настройках приложения.
* **TR-LANG-1.3:** Выбранный язык сохраняется в локальной таблице `settings` и применяется при каждом запуске приложения.

### TR-LANG-2. Язык интерфейса приложения

* **TR-LANG-2.1:** Все элементы интерфейса (меню, кнопки, заголовки, сообщения, экраны) должны отображаться на выбранном языке.
* **TR-LANG-2.2:** Переключение языка должно быть доступно в разделе «Настройки» приложения.
* **TR-LANG-2.3:** При первом запуске приложения язык определяется по системным настройкам устройства (если поддерживается), иначе используется грузинский по умолчанию.

### TR-LANG-3. Мультиязычный контент — Отцы

* **TR-LANG-3.1:** Приложение должно отображать контент отцов на выбранном языке пользователя:
  * `name_ka` / `name_ru` — имя отца
  * `bio_ka` / `bio_ru` — биография отца
* **TR-LANG-3.2:** При отсутствии перевода на выбранный язык система должна использовать грузинский как fallback.
* **TR-LANG-3.3:** Все переводы отцов должны храниться в локальной базе SQLite и синхронизироваться с сервером.

### TR-LANG-4. Мультиязычный контент — Цитаты

* **TR-LANG-4.1:** Приложение должно отображать цитаты на выбранном языке пользователя:
  * `text_ka` / `text_ru` — текст цитаты
  * `source_ka` / `source_ru` — источник цитаты
* **TR-LANG-4.2:** При отсутствии перевода на выбранный язык система должна использовать грузинский как fallback.
* **TR-LANG-4.3:** Все переводы цитат должны храниться в локальной базе SQLite и синхронизироваться с сервером.

### TR-LANG-5. Синхронизация мультиязычного контента

* **TR-LANG-5.1:** При синхронизации с сервером приложение должно загружать все доступные переводы (как грузинские, так и русские версии).
* **TR-LANG-5.2:** Локальная база данных должна хранить все языковые версии контента независимо от выбранного языка интерфейса.
* **TR-LANG-5.3:** Переключение языка интерфейса не требует повторной синхронизации — все переводы уже должны быть в локальной базе.

### TR-LANG-6. Офлайн-режим и мультиязычность

* **TR-LANG-6.1:** Все переводы должны быть доступны офлайн после первой успешной синхронизации.
* **TR-LANG-6.2:** Переключение языка интерфейса должно работать без доступа к интернету.

---

## 11. Definition of Done (инфраструктура и офлайн)

Система считается готовой, если:

* приложение запускается и полностью работает в авиарежиме после первой загрузки;
* все изображения отображаются офлайн;
* удаление контента в админке корректно отражается в приложении после синка;
* данные никогда не читаются напрямую из сети для отображения UI;
* приложение поддерживает переключение между грузинским и русским языками интерфейса;
* весь контент (отцы, цитаты) отображается на выбранном языке с fallback на грузинский;
* переключение языка работает офлайн без необходимости повторной синхронизации.
