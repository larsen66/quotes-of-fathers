<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Images to Supabase</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .upload-area {
      border: 2px dashed #ccc;
      padding: 40px;
      text-align: center;
      margin: 20px 0;
      border-radius: 8px;
    }
    .upload-area.dragover {
      background-color: #f0f0f0;
      border-color: #007bff;
    }
    button {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      background-color: #f8f9fa;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .preview-item {
      text-align: center;
    }
    .preview-item img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #ddd;
    }
    .preview-item p {
      margin: 5px 0;
      font-size: 12px;
      color: #666;
    }
    .url-output {
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      word-break: break-all;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h1>üñºÔ∏è Upload Father Images to Supabase</h1>
  
  <div class="upload-area" id="dropArea">
    <p>üìÅ Drag & Drop images here or click to select</p>
    <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
    <button onclick="document.getElementById('fileInput').click()">Select Images</button>
  </div>

  <div id="preview" class="preview"></div>

  <button id="uploadBtn" onclick="uploadImages()" disabled>Upload to Supabase</button>
  <button onclick="clearAll()">Clear All</button>

  <div id="result"></div>

  <script>
    const SUPABASE_URL = 'https://kprqbfxzbclouateifeh.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_iTXQOpOdhAD3jHFnkLxhVQ_kSztD4zI';
    
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let selectedFiles = [];

    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const uploadBtn = document.getElementById('uploadBtn');
    const result = document.getElementById('result');

    // Drag and drop events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => {
        dropArea.classList.add('dragover');
      }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => {
        dropArea.classList.remove('dragover');
      }, false);
    });

    dropArea.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      handleFiles(files);
    }, false);

    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    function handleFiles(files) {
      selectedFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
      displayPreview();
      uploadBtn.disabled = selectedFiles.length === 0;
    }

    function displayPreview() {
      preview.innerHTML = '';
      selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const div = document.createElement('div');
          div.className = 'preview-item';
          div.innerHTML = `
            <img src="${e.target.result}" alt="${file.name}">
            <p>${file.name}</p>
            <p>${(file.size / 1024).toFixed(1)} KB</p>
          `;
          preview.appendChild(div);
        };
        reader.readAsDataURL(file);
      });
    }

    async function uploadImages() {
      uploadBtn.disabled = true;
      result.innerHTML = '<p>‚è≥ Uploading images...</p>';

      const uploadedUrls = [];

      try {
        for (let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          const fileName = `father-${i + 1}.${file.name.split('.').pop()}`;
          const filePath = `avatars/${fileName}`;

          result.innerHTML += `<p>Uploading ${fileName}...</p>`;

          const { data, error } = await supabaseClient.storage
            .from('fathers')
            .upload(filePath, file, {
              cacheControl: '3600',
              upsert: true
            });

          if (error) {
            throw new Error(`Failed to upload ${fileName}: ${error.message}`);
          }

          const { data: urlData } = supabaseClient.storage
            .from('fathers')
            .getPublicUrl(filePath);

          uploadedUrls.push({
            fileName,
            url: urlData.publicUrl
          });

          result.innerHTML += `<p class="success">‚úÖ ${fileName} uploaded!</p>`;
        }

        // Show URLs
        result.innerHTML += '<h3>‚úÖ All images uploaded successfully!</h3>';
        result.innerHTML += '<h4>Public URLs:</h4>';
        uploadedUrls.forEach(({ fileName, url }) => {
          result.innerHTML += `<div class="url-output"><strong>${fileName}:</strong><br>${url}</div>`;
        });

        // Generate SQL update
        result.innerHTML += '<h4>SQL to update database:</h4>';
        result.innerHTML += '<div class="url-output">';
        uploadedUrls.forEach(({ url }, index) => {
          const fatherId = `f${(index + 1).toString().repeat(8)}-${(index + 1).toString().repeat(4)}-${(index + 1).toString().repeat(4)}-${(index + 1).toString().repeat(4)}-${(index + 1).toString().repeat(12)}`;
          result.innerHTML += `UPDATE fathers SET avatar_url = '${url}', profile_image_url = '${url}', updated_at = NOW() WHERE id = '${fatherId}';<br>`;
        });
        result.innerHTML += '</div>';

        result.className = 'result success';
      } catch (error) {
        result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
        result.className = 'result error';
      } finally {
        uploadBtn.disabled = false;
      }
    }

    function clearAll() {
      selectedFiles = [];
      preview.innerHTML = '';
      result.innerHTML = '';
      fileInput.value = '';
      uploadBtn.disabled = true;
    }
  </script>
</body>
</html>
